<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Create Map</title>
    </head>
    <body>
        <h1 style="text-align:center">Create Map</h1>
        <canvas style="margin-left:5%; margin-right:5%" width=1600 height=800 id="map"></canvas>
        <button id="download" style="margin-left:5%; margin-right:5%" >Download CSV</button>
    </body>
    <script>
        var mapCanvas = document.getElementById('map');
        var mapCtx = mapCanvas.getContext('2d');

        class Map {
            constructor(width, height) {
                this.tiles = [];
                this.width = width;
                this.height = height;
                for (var i = 0; i < this.height; ++i) {
                    var row = [];
                    for (var j = 0; j < this.width; ++j) {
                        row[j] = 0;
                    }
                    this.tiles[i] = row;
                }
            }

            toX(x) {
                return Math.floor(map.width * x / mapCanvas.width);
            }

            toY(y) {
                return Math.floor(map.height * y / mapCanvas.height);
            }

            cycle(x, y, addWidth, addHeight) {
                for (var i = 0; i < addWidth; ++i) {
                    for (var j = 0; j < addHeight; ++j) {
                        this.tiles[y + j][x + i] = (this.tiles[y + j][x + i] + 1) % 2;
                    }
                }
            }

            toCSV() {
                var csv = "";
                for (var i in this.tiles) {
                    for (var j in this.tiles[i]) {
                        csv += `${this.tiles[i][j] == 1 ? "w" : "l"},`;
                    }
                    csv = csv.slice(0, -1) + "\n";
                }
                return csv;
            }
        }

        var map = new Map(600, 500);

        window.onload = () => {
            drawMap();
        }

        function drawMap() {
            for (var y in map.tiles) {
                for (var x in  map.tiles[y]) {
                    drawTile(x, y);
                }
            }
        }

        function drawTile(x, y, addWidth=1, addHeight=1) {
            switch (map.tiles[y][x]) {
                case 0:
                    mapCtx.fillStyle = "#00FF00";
                    break;
                case 1:
                    mapCtx.fillStyle = "#0000FF";
                    break;
            }
            mapCtx.fillRect(
                x * (mapCanvas.width / map.width),
                y * (mapCanvas.height / map.height),
                addWidth * mapCanvas.width / map.width,
                addHeight * mapCanvas.height / map.height
            );
        }

        var interval = '';
        var colouring = false;

        mapCanvas.addEventListener("mousedown", () => {
            colouring = true;
        }, false);

        mapCanvas.addEventListener("mouseup", () => {
            colouring = false;
        }, false);

        mapCanvas.addEventListener("mouseleave", () => {
            colouring = false;
        }, false);

        mapCanvas.addEventListener("mousemove", (event) => {
            if (colouring) {
                var rect = mapCanvas.getBoundingClientRect();
                var x = map.toX(event.clientX - rect.left);
                console.log(`pre-x: ${event.clientX - rect.left}`)
                console.log(`canvas width: ${mapCanvas.width}`)
                var y = map.toY(event.clientY - rect.top);
                console.log(`x: ${x}, y: ${y}`)
                console.log(`map tile x, y: ${map.tiles[y][x]}`)
                map.cycle(x, y, 10, 10);
                console.log(`map tile x, y: ${map.tiles[y][x]}`)
                drawTile(x, y, 10, 10);
            }
        }, false);

        document.getElementById("download").addEventListener("click", () => {
            var csvBlob = new Blob([map.toCSV()], { type: 'text/plain' })
            window.location.href = window.URL.createObjectURL(csvBlob);
        })
    </script>
</html>
